<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Статистика переходов</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .stats-header { margin-bottom: 20px; }
        .chart-container { display: flex; flex-wrap: wrap; gap: 20px; margin: 20px 0; }
        .chart-box { width: 400px; height: 300px; }
        .section { margin: 30px 0; }
    </style>
</head>
<body>
<div class="stats-header">
    <h1>Статистика переходов</h1>
    <p><strong>Оригинальная ссылка:</strong> <span th:text="${link.originalUrl}"></span></p>
    <p><strong>Короткий код:</strong> <span th:text="${link.shortCode}"></span></p>
    <p><strong>Создана:</strong> <span th:text="${#temporals.format(link.createdAt, 'dd.MM.yyyy HH:mm')}"></span></p>
    <p><strong>Истекает:</strong> <span th:text="${link.expiresAt != null ? #temporals.format(link.expiresAt, 'dd.MM.yyyy HH:mm') : 'Никогда'}"></span></p>
    <p><strong>Всего переходов:</strong> <span th:text="${link.clickCount}"></span></p>
    <p><strong>Уникальных посетителей:</strong> <span th:text="${visitorCount}"></span></p>
</div>

<div class="section">
    <h2>География переходов</h2>
    <div class="chart-container">
        <div class="chart-box">
            <canvas id="countryChart"></canvas>
        </div>
    </div>
</div>

<div class="section">
    <h2>Источники трафика</h2>
    <div class="chart-container">
        <div class="chart-box">
            <canvas id="referrerChart"></canvas>
        </div>
    </div>
</div>

<div class="section">
    <h2>Устройства и браузеры</h2>
    <div class="chart-container">
        <div class="chart-box">
            <canvas id="browserChart"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="osChart"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="deviceChart"></canvas>
        </div>
    </div>
</div>

<div class="section">
    <h2>Последние переходы</h2>
    <table>
        <thead>
        <tr>
            <th>Время</th>
            <th>Страна</th>
            <th>Устройство</th>
            <th>ОС</th>
            <th>Браузер</th>
            <th>Источник</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="visitor : ${recentVisitors}">
            <td th:text="${#temporals.format(visitor.visitedAt, 'dd.MM.yyyy HH:mm')}"></td>
            <td th:text="${visitor.country} ?: 'Unknown'"></td>
            <td th:text="${visitor.deviceType}"></td>
            <td th:text="${visitor.operatingSystem}"></td>
            <td th:text="${visitor.browser}"></td>
            <td th:text="${visitor.referrer} ?: 'Direct'"></td>
        </tr>
        </tbody>
    </table>
</div>

<br>
<a href="/">Вернуться на главную</a>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Подготовка данных для диаграмм
    const prepareChartData = (statsMap, limit = 10) => {
        const entries = Object.entries(statsMap);
        entries.sort((a, b) => b[1] - a[1]);
        const topEntries = entries.slice(0, limit);

        return {
            labels: topEntries.map(entry => entry[0]),
            data: topEntries.map(entry => entry[1]),
            total: entries.reduce((sum, entry) => sum + entry[1], 0)
        };
    };

    // Данные из Thymeleaf
    const countryData = prepareChartData(/*[[${countryStats}]]*/ {});
    const referrerData = prepareChartData(/*[[${referrerStats}]]*/ {});
    const browserData = prepareChartData(/*[[${browserStats}]]*/ {});
    const osData = prepareChartData(/*[[${osStats}]]*/ {});
    const deviceData = prepareChartData(/*[[${deviceStats}]]*/ {});

    // Функция создания диаграммы
    const createChart = (canvasId, data, chartType = 'pie') => {
        new Chart(document.getElementById(canvasId), {
            type: chartType,
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const percentage = Math.round((value / data.total) * 100);
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    };

    // Создание диаграмм
    if (countryData.labels.length > 0) createChart('countryChart', countryData);
    if (referrerData.labels.length > 0) createChart('referrerChart', referrerData);
    if (browserData.labels.length > 0) createChart('browserChart', browserData);
    if (osData.labels.length > 0) createChart('osChart', osData);
    if (deviceData.labels.length > 0) createChart('deviceChart', deviceData);
    /*]]>*/
</script>
</body>
</html>